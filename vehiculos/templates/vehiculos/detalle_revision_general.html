{% load static %}
{% load my_filters %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Revisión General - {{ vehiculo.marca }} {{ vehiculo.modelo }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{% static 'img/logo2.png' %}" type="image/png">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0765CB;
            --primary-dark: #04239A;
            --secondary-color: #FFC107;
            --secondary-dark: #FFA000;
            --accent-color: #E74C3C;
            --light-gray: #F8F9FA;
            --dark-gray: #212529;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--light-gray);
            padding-top: 4.5rem;
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .navbar-brand:hover {
            transform: scale(1.05);
        }

        .navbar-brand img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        @media (max-width: 576px) {
            .navbar-brand img {
                height: 40px;
            }
        }

        .main-card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            background: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 1rem 0;
            padding: 1.5rem;
        }

        @media (min-width: 768px) {
            .main-card {
                padding: 2rem;
                margin: 2rem 0;
            }
        }

        .section-card {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            border-radius: var(--border-radius);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background: white;
            position: relative;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.1rem;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-good { background-color: #28a745; color: white; }
        .badge-regular { background-color: #ffc107; color: black; }
        .badge-bad { background-color: #dc3545; color: white; }
        .badge-na { background-color: #6c757d; color: white; }

        /* Estilos para galería de imágenes */
        .media-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .file-input-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-input-label:hover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .file-input-label.dragover {
            border-color: var(--primary-color);
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .gallery-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gallery-item:hover .gallery-remove {
            opacity: 1;
        }

        .image-counter {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .btn-save {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            border: none;
            transition: all 0.3s;
            width: 100%;
        }

        @media (min-width: 768px) {
            .btn-save {
                width: auto;
            }
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(7, 101, 203, 0.3);
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }

        .form-select, .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(7, 101, 203, 0.25);
        }

        /* Botones de captura */
        .capture-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-camera {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: black;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-camera:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        /* Modal de cámara */
        .camera-modal .modal-content {
            border-radius: 12px;
            overflow: hidden;
        }

        .camera-preview {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
        }

        .btn-capture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .captured-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }

        /* Mejoras para móviles */
        @media (max-width: 767.98px) {
            body {
                padding-top: 4rem;
            }
            
            .main-card {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 8px;
            }
            
            .section-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .section-title {
                font-size: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            
            .gallery-image {
                height: 80px;
            }
            
            .capture-buttons {
                flex-direction: column;
            }
            
            .btn-camera {
                width: 100%;
            }
        }

        /* Estados de carga */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .file-info {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top px-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'index' %}">
            <img src="{% static 'img/logo2.png' %}" alt="Moster Check">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <i class="bi bi-list text-white" style="font-size: 1.5rem;"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'ver_reporte_vehiculo' id=vehiculo.id %}">
                        <button class="btn btn-outline-light rounded-pill px-3" type="submit">
                            <i class="bi bi-box-arrow-right"></i> Volver al Reporte
                        </button>
                    </a>
                </li>
            </ul>
            <form method="post" action="{% url 'logout' %}" class="d-flex">
                {% csrf_token %}
                <button class="btn btn-outline-light rounded-pill px-3" type="submit">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </button>
            </form>
        </div>
    </div>
</nav>

<!-- CONTENIDO -->
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <div class="main-card">
                <!-- Header -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                    <div class="mb-3 mb-md-0">
                        <h2 class="mb-1"><i class="bi bi-clipboard-check text-primary me-2"></i>Revisión General</h2>
                        <p class="text-muted mb-0">
                            {{ vehiculo.marca }} {{ vehiculo.modelo }} 
                            {% if vehiculo.patente %} - {{ vehiculo.patente }}{% endif %}
                        </p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary p-2">#{{ vehiculo.numero_orden }}</span>
                        {% if vehiculo.vin %}
                        <span class="badge bg-dark p-2">VIN: {{ vehiculo.vin }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Formulario -->
                <form method="post" id="inspection-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% for clave, label in puntos_revision %}
                    <div class="section-card" id="section-{{ clave }}">
                        <h5 class="section-title">
                            <i class="bi bi-check-circle me-2"></i> {{ label }}
                            {% with punto=puntos|dict_get:clave %}
                                {% if punto %}
                                <span class="status-badge 
                                    {% if punto.estado == 'BUENO' %}badge-good
                                    {% elif punto.estado == 'OBSERVACION' %}badge-regular
                                    {% elif punto.estado == 'RECHAZADO' %}badge-bad
                                    {% else %}badge-na{% endif %}">
                                    {{ punto.get_estado_display }}
                                </span>
                                {% endif %}
                            {% endwith %}
                        </h5>
                        
                        <div class="row g-3">
                            <!-- Controles de estado y observaciones -->
                            <div class="col-12 col-md-6">
                                <div class="mb-3">
                                    <label for="estado_{{ clave }}" class="form-label">Estado:</label>
                                    <select class="form-select" name="estado_{{ clave }}" id="estado_{{ clave }}" required>
                                        <option value="" disabled selected>Seleccione el estado</option>
                                        <option value="BUENO" {% with punto=puntos|dict_get:clave %}{% if punto and punto.estado == 'BUENO' %}selected{% endif %}{% endwith %}>Bueno</option>
                                        <option value="OBSERVACION" {% with punto=puntos|dict_get:clave %}{% if punto and punto.estado == 'OBSERVACION' %}selected{% endif %}{% endwith %}>En Observación</option>
                                        <option value="RECHAZADO" {% with punto=puntos|dict_get:clave %}{% if punto and punto.estado == 'RECHAZADO' %}selected{% endif %}{% endwith %}>Rechazado</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="observaciones_{{ clave }}" class="form-label">Observaciones:</label>
                                    <textarea class="form-control" name="observaciones_{{ clave }}" 
                                              id="observaciones_{{ clave }}" rows="3" 
                                              placeholder="Agregar observaciones...">{% with punto=puntos|dict_get:clave %}{{ punto.observacion|default:"" }}{% endwith %}</textarea>
                                </div>
                            </div>

                            <!-- Área de carga de imágenes -->
                            <div class="col-12 col-md-6">
                                <div class="media-container">
                                    <!-- Input de archivos -->
                                    <div class="file-input-container">
                                        <label for="file_input_{{ clave }}" class="file-input-label" id="file_label_{{ clave }}">
                                            <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-2"></i>
                                            <div class="fw-semibold">Seleccionar imágenes</div>
                                            <small class="text-muted">Haz clic o arrastra archivos aquí</small>
                                            <div class="file-info">
                                                Formatos: JPG, PNG, GIF • Máx. 5MB por imagen
                                            </div>
                                        </label>
                                        <input type="file" 
                                               class="file-input" 
                                               id="file_input_{{ clave }}" 
                                               name="imagenes_{{ clave }}"
                                               multiple 
                                               accept="image/*"
                                               onchange="handleFileSelect('{{ clave }}', this.files)">
                                    </div>

                                    <!-- Botones de captura -->
                                    <div class="capture-buttons">
                                        <button type="button" class="btn btn-camera" onclick="openCamera('{{ clave }}')">
                                            <i class="bi bi-camera me-2"></i> Tomar Foto
                                        </button>
                                        <button type="button" class="btn btn-camera" onclick="openCamera('{{ clave }}', 'environment')">
                                            <i class="bi bi-camera-video me-2"></i> Cámara Trasera
                                        </button>
                                    </div>

                                    <!-- Galería de imágenes -->
                                    <div class="image-gallery" id="gallery_{{ clave }}">
                                        <!-- Imágenes existentes -->
                                        {% with punto=puntos|dict_get:clave %}
                                        {% if punto and punto.imagenes.exists %}
                                            {% for imagen in punto.imagenes.all %}
                                            <div class="gallery-item">
                                                <img src="data:image/jpeg;base64,{{ imagen.imagen_base64 }}" 
                                                     class="gallery-image" 
                                                     alt="Imagen existente {{ forloop.counter }}"
                                                     onclick="openImageModal('data:image/jpeg;base64,{{ imagen.imagen_base64 }}')">
                                                <span class="image-counter">{{ forloop.counter }}</span>
                                                <!-- No mostrar botón de eliminar para imágenes existentes -->
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                        {% endwith %}
                                        
                                        <!-- Nuevas imágenes se agregarán aquí dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Botones de acción -->
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mt-4 pt-3 border-top">
                        <a href="{% url 'listar_vehiculos' %}" class="btn btn-outline-secondary order-2 order-md-1">
                            <i class="bi bi-arrow-left-circle me-2"></i> Volver a la lista
                        </a>
                        <button type="submit" class="btn btn-save order-1 order-md-2" id="submit-btn">
                            <i class="bi bi-save me-2"></i> Guardar Revisión
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver imagen en grande -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vista de Imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" style="max-height: 70vh; border-radius: 8px;">
            </div>
        </div>
    </div>
</div>

<!-- Modal para captura de cámara -->
<div class="modal fade camera-modal" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tomar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="camera-preview mb-3">
                    <video id="cameraPreview" autoplay playsinline style="width: 100%; height: 300px; object-fit: cover;"></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                </div>
                <div class="camera-controls">
                    <button type="button" class="btn btn-capture" id="captureBtn">
                        <i class="bi bi-camera"></i>
                    </button>
                </div>
                <div id="capturedPreview" style="display: none;">
                    <img id="capturedImage" class="captured-image" src="" alt="Captured image">
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button type="button" class="btn btn-success" id="acceptPhotoBtn">
                            <i class="bi bi-check-lg me-2"></i>Aceptar
                        </button>
                        <button type="button" class="btn btn-danger" id="retakePhotoBtn">
                            <i class="bi bi-arrow-repeat me-2"></i>Volver a Tomar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Almacenar imágenes por sección
const sectionImages = {};
let currentSection = '';
let stream = null;
let cameraFacingMode = 'user'; // 'user' para frontal, 'environment' para trasera

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    {% for clave, label in puntos_revision %}
        sectionImages['{{ clave }}'] = {
            existing: [],
            new: []
        };
        
        // Cargar imágenes existentes
        {% with punto=puntos|dict_get:clave %}
            {% if punto %}
                {% for imagen in punto.imagenes.all %}
                    sectionImages['{{ clave }}'].existing.push({
                        id: 'existing_{{ forloop.counter }}',
                        base64: '{{ imagen.imagen_base64 }}',
                        isExisting: true
                    });
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        updateGallery('{{ clave }}');
        setupDragAndDrop('{{ clave }}');
    {% endfor %}
});

// Configurar drag and drop
function setupDragAndDrop(clave) {
    const label = document.getElementById('file_label_' + clave);
    const fileInput = document.getElementById('file_input_' + clave);
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        label.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        label.classList.add('dragover');
    }
    
    function unhighlight() {
        label.classList.remove('dragover');
    }
    
    label.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFileSelect(clave, files);
    }
}

// Manejar selección de archivos
function handleFileSelect(clave, files) {
    const maxSize = 5 * 1024 * 1024; // 5MB
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    
    for (let file of files) {
        // Validar tipo de archivo
        if (!validTypes.includes(file.type)) {
            alert(`El archivo "${file.name}" no es una imagen válida. Solo se permiten JPG, PNG, GIF y WebP.`);
            continue;
        }
        
        // Validar tamaño
        if (file.size > maxSize) {
            alert(`El archivo "${file.name}" es demasiado grande. Máximo 5MB permitido.`);
            continue;
        }
        
        // Convertir a base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1];
            sectionImages[clave].new.push({
                id: 'new_' + Date.now() + Math.random(),
                base64: base64,
                isExisting: false,
                fileName: file.name
            });
            updateGallery(clave);
        };
        reader.readAsDataURL(file);
    }
    
    // Limpiar input
    document.getElementById('file_input_' + clave).value = '';
}

// Abrir cámara
function openCamera(section, facingMode = 'user') {
    currentSection = section;
    cameraFacingMode = facingMode;
    
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    cameraModal.show();
    
    // Inicializar cámara cuando el modal se muestre
    document.getElementById('cameraModal').addEventListener('shown.bs.modal', function() {
        initializeCamera();
    });
    
    // Detener cámara cuando el modal se cierre
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
        stopCamera();
    });
}

// Inicializar cámara
async function initializeCamera() {
    const video = document.getElementById('cameraPreview');
    const constraints = {
        video: {
            facingMode: cameraFacingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };
    
    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // Configurar botones
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('capturedPreview').style.display = 'none';
    } catch (err) {
        console.error('Error al acceder a la cámara:', err);
        alert('No se pudo acceder a la cámara. Asegúrate de que tienes permisos para usar la cámara.');
    }
}

// Detener cámara
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

// Capturar foto
document.getElementById('captureBtn').addEventListener('click', function() {
    const video = document.getElementById('cameraPreview');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    // Configurar canvas con las dimensiones del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Dibujar el frame actual del video en el canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Obtener la imagen como base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    const base64 = imageData.split(',')[1];
    
    // Mostrar la imagen capturada
    document.getElementById('capturedImage').src = imageData;
    document.getElementById('capturedPreview').style.display = 'block';
    document.getElementById('captureBtn').style.display = 'none';
    
    // Detener la cámara después de capturar
    stopCamera();
});

// Aceptar foto
document.getElementById('acceptPhotoBtn').addEventListener('click', function() {
    const imageData = document.getElementById('capturedImage').src;
    const base64 = imageData.split(',')[1];
    
    // Agregar la imagen a la sección actual
    sectionImages[currentSection].new.push({
        id: 'camera_' + Date.now(),
        base64: base64,
        isExisting: false,
        fileName: 'camera_' + Date.now() + '.jpg'
    });
    
    updateGallery(currentSection);
    
    // Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
});

// Volver a tomar foto
document.getElementById('retakePhotoBtn').addEventListener('click', function() {
    document.getElementById('capturedPreview').style.display = 'none';
    document.getElementById('captureBtn').style.display = 'block';
    initializeCamera();
});

// Actualizar galería
function updateGallery(clave) {
    const gallery = document.getElementById('gallery_' + clave);
    const allImages = [...sectionImages[clave].existing, ...sectionImages[clave].new];
    
    gallery.innerHTML = '';
    
    allImages.forEach((image, index) => {
        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item';
        
        const img = document.createElement('img');
        img.src = `data:image/jpeg;base64,${image.base64}`;
        img.className = 'gallery-image';
        img.alt = `Imagen ${index + 1}`;
        img.onclick = () => openImageModal(`data:image/jpeg;base64,${image.base64}`);
        
        const counter = document.createElement('span');
        counter.className = 'image-counter';
        counter.textContent = index + 1;
        
        galleryItem.appendChild(img);
        galleryItem.appendChild(counter);
        
        // Solo agregar botón de eliminar para imágenes nuevas
        if (!image.isExisting) {
            const removeBtn = document.createElement('button');
            removeBtn.className = 'gallery-remove';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeImage(clave, image.id);
            };
            galleryItem.appendChild(removeBtn);
        }
        
        gallery.appendChild(galleryItem);
    });
    
    updateHiddenInputs(clave);
}

// Eliminar imagen
function removeImage(clave, imageId) {
    sectionImages[clave].new = sectionImages[clave].new.filter(img => img.id !== imageId);
    updateGallery(clave);
}

// Actualizar inputs ocultos
function updateHiddenInputs(clave) {
    // Eliminar inputs anteriores
    const oldInputs = document.querySelectorAll(`input[name="imagenes_${clave}[]"]`);
    oldInputs.forEach(input => input.remove());
    
    // Crear nuevos inputs para imágenes nuevas
    const form = document.getElementById('inspection-form');
    sectionImages[clave].new.forEach(image => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `imagenes_${clave}[]`;
        input.value = image.base64;
        form.appendChild(input);
    });
}

// Abrir modal de imagen
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

// Manejar envío del formulario
document.getElementById('inspection-form').addEventListener('submit', function(e) {
    // Validar que al menos un punto tenga estado seleccionado
    let hasSelection = false;
    {% for clave, label in puntos_revision %}
        if (document.getElementById('estado_{{ clave }}').value) {
            hasSelection = true;
        }
    {% endfor %}
    
    if (!hasSelection) {
        e.preventDefault();
        alert('Por favor, selecciona el estado para al menos un punto de revisión.');
        return;
    }
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
});
</script>
</body>
</html>